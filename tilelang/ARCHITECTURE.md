# TileLang-Ascend 架构图

## 目录结构概览

```
tilelang-ascend/
│
├── tilelang/              ◄─── Python DSL 和编译器前端（用户接口层）
│   ├── jit/              ◄─── JIT 即时编译器
│   ├── language/         ◄─── 语言接口和原语（T.alloc_L1, T.copy, T.gemm等）
│   ├── engine/           ◄─── 编译引擎核心（IR降层）
│   ├── transform/        ◄─── Python层IR变换
│   ├── autotuner/        ◄─── 自动调优器
│   ├── carver/           ◄─── 核心调度器
│   ├── layout/           ◄─── 内存布局定义
│   ├── primitives/       ◄─── 底层计算原语
│   └── cache/            ◄─── 编译缓存
│
├── src/                  ◄─── C++ 后端实现（核心编译器）
│   ├── tl_templates/     ◄─── 代码生成模板库
│   │   ├── ascend/       ◄─── Ascend 特定模板
│   │   ├── cuda/
│   │   ├── hip/
│   │   └── cpu/
│   ├── transform/        ◄─── IR变换Pass（C++实现）
│   ├── target/           ◄─── 目标代码生成器
│   │   ├── codegen_ascend_pto.cc  ◄─── Ascend C/PTO代码生成
│   │   ├── codegen_cuda.cc
│   │   ├── rt_mod_ascend_pto.cc   ◄─── Ascend运行时
│   │   └── ...
│   ├── runtime/          ◄─── 运行时支持
│   ├── layout/           ◄─── 布局处理
│   └── op/               ◄─── 操作定义
│
├── 3rdparty/             ◄─── 第三方依赖
│   ├── tvm/              ◄─── TVM编译器基础设施
│   ├── pto-isa/          ◄─── PTO指令集定义
│   ├── cutlass/          ◄─── CUTLASS矩阵库
│   └── composable_kernel/
│
├── examples/             ◄─── 示例代码
│   ├── gemm/             ◄─── 矩阵乘法示例
│   ├── flash_attention/  ◄─── Flash Attention实现
│   ├── elementwise/      ◄─── 逐元素操作
│   ├── pipeline/         ◄─── 流水线示例
│   └── ...
│
├── docs/                 ◄─── 项目文档
│   ├── get_started/      ◄─── 入门指南
│   ├── tutorials/        ◄─── 教程
│   └── language_ref/     ◄─── 语言参考
│
├── testing/              ◄─── 测试代码
├── benchmark/            ◄─── 性能基准测试
│
├── setup.py              ◄─── Python包安装
├── CMakeLists.txt        ◄─── C++构建配置
├── install_ascend.sh     ◄─── Ascend平台安装
└── README.md             ◄─── 英文说明
```

---

## 完整编译流程架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户层                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  examples/gemm/example_gemm.py                                   │   │
│  │                                                                  │   │
│  │  @tilelang.jit(out_idx=[-1])                                    │   │
│  │  def matmul(M, N, K, ...):                                      │   │
│  │      @T.prim_func                                               │   │
│  │      def main(A: T.Tensor, B: T.Tensor, C: T.Tensor):          │   │
│  │          with T.Kernel(...) as (cid, _):                        │   │
│  │              A_L1 = T.alloc_L1(...)        ◄─── 内存分配        │   │
│  │              T.copy(A[...], A_L1)         ◄─── 数据搬运         │   │
│  │              T.gemm_v0(A_L1, B_L1, C_L0)  ◄─── 矩阵计算        │   │
│  │              T.copy(C_L0, C[...])         ◄─── 结果写回        │   │
│  │  return main                                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         Python DSL 层                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  tilelang/jit/__init__.py                                       │   │
│  │  ┌────────────────────────────────────────────────────────┐    │   │
│  │  │  @tilelang.jit                                          │    │   │
│  │  │      │                                                  │    │   │
│  │  │      ├─ 解析函数参数                                    │    │   │
│  │  │      ├─ 构建编译配置                                    │    │   │
│  │  │      └─ 调用 tilelang.engine.lower                     │    │   │
│  │  └────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  tilelang/language/                                             │   │
│  │  ├─ prim_func           →  TIR 函数定义                          │   │
│  │  ├─ allocate.py         →  alloc_L1, alloc_ub, alloc_L0A/B/C   │   │
│  │  ├─ copy.py             →  T.copy 数据搬运                      │   │
│  │  ├─ gemm.py             →  T.gemm, T.mma 矩阵计算               │   │
│  │  ├─ parallel.py         →  T.Parallel 并行原语                  │   │
│  │  ├─ pipeline.py         →  T.Pipelined 流水线                   │   │
│  │  ├─ ascend.py           →  Ascend 特定原语                      │   │
│  │  └─ ascend_tile.py      →  Tile 操作                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ 输出 TIR (Tensor IR)
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       降层引擎                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  tilelang/engine/lower.py                                       │   │
│  │                                                                  │   │
│  │  lower(func, target="ascend", pass_configs={...})               │   │
│  │      │                                                          │   │
│  │      ├─ 创建 PassContext                                        │   │
│  │      ├─ 应用前端变换                                            │   │
│  │      ├─ 应用硬件特定变换                                        │   │
│  │      └─ 生成目标代码                                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ TIR
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    IR 变换 Pass 层                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  通用变换 (src/transform/)                                       │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 1. frontend_legalize.cc       →  前端合法化              │   │   │
│  │  │    - 标准化 IR 结构                                      │   │   │
│  │  │    - 类型检查和转换                                      │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 2. layout_inference.cc         →  布局推断               │   │   │
│  │  │    - 推断最优内存布局                                    │   │   │
│  │  │    - 应用布局注解                                        │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 3. flatten_buffer.cc            →  缓冲区扁平化           │   │   │
│  │  │    - 多维缓冲区转换为一维                                │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 4. loop_vectorize.cc            →  循环向量化            │   │   │
│  │  │    - SIMD 向量化                                          │   │   │
│  │  │    - 循环展开                                             │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 5. inject_pipeline.cc           →  流水线注入            │   │   │
│  │  │    - T.Pipelined → 实际流水线调度                        │   │   │
│  │  │    - 计算与数据传输重叠                                   │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Ascend 特定变换 (src/transform/ascend_*.cc)                    │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 6. ascend_lower_parallel_to_vector.cc                     │   │   │
│  │  │    →  T.Parallel → Vector 指令                            │   │   │
│  │  │    for i in T.Parallel(N):                                │   │   │
│  │  │        C[i] = A[i] + B[i]                                 │   │   │
│  │  │    ↓                                                       │   │   │
│  │  │    T.add(C, A, B)  # Vectorized add                       │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 7. ascend_memory_planning.cc      →  自动内存规划         │   │   │
│  │  │    - 缓冲区重用                                           │   │   │
│  │  │    - 地址分配                                             │   │   │
│  │  │    - 生命周期分析                                         │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 8. ascend_sync_insert.cc          →  同步指令自动插入     │   │   │
│  │  │    - 自动插入 barrier                                     │   │   │
│  │  │    - 依赖分析                                             │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 9. ascend_combinecv.cc            →  AIC/AIV 核心合并     │   │   │
│  │  │    - Cube核和Vector核代码合并                             │   │   │
│  │  │    - 核间通信优化                                         │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │ 10. lower_tile_op.cc               →  Tile操作降层        │   │   │
│  │  │     - T.tile.add → 实际加法指令                            │   │   │
│  │  │     - T.tile.mul → 实际乘法指令                            │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ 优化后的 TIR
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      代码生成层                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  src/target/codegen_ascend_pto.cc                               │   │
│  │                                                                  │   │
│  │  TIR  →  Ascend C 代码 + PTO 指令                                │   │
│  │                                                                  │   │
│  │  示例转换：                                                       │   │
│  │  ┌──────────────────────────────────────────────────────────┐  │   │
│  │  │  TIR:                                                    │  │   │
│  │  │    T.gemm_v0(A_L1, B_L1, C_L0, init=True)               │  │   │
│  │  │                                                          │  │   │
│  │  │  Ascend C:                                               │  │   │
│  │  │   pipe->GEMM(A_L1, B_L1, C_L0, {1, 1, 1, 1, 0, 0});     │  │   │
│  │  └──────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  src/tl_templates/ascend/common.h                               │   │
│  │  - 代码生成模板                                                   │   │
│  │  - 通用宏定义                                                     │   │
│  │  - 辅助函数                                                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ Ascend C 源码
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     外部工具链（华为 CANN）                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Ascend C 编译器                                                 │   │
│  │    - 编译 Ascend C 代码                                          │   │
│  │    - 生成二进制文件 (.o / .so)                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  PTO 汇编器                                                       │   │
│  │    - 处理 PTO 指令                                               │   │
│  │    - 生成机器码                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ 可执行二进制
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       运行时层                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  tilelang 运行时 (src/target/rt_mod_ascend_pto.cc)               │   │
│  │    - 加载二进制内核                                               │   │
│  │    - 参数传递                                                     │   │
│  │    - 内存管理                                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  CANN 运行时                                                      │   │
│  │    - rt Stream 管理                                              │   │
│  │    - NPU 设备接口                                                │   │
│  │    - 内存分配/释放                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      Ascend NPU 硬件                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐             │   │
│  │  │  AIC    │  │  AIC    │  │  AIV    │  │  AIV    │             │   │
│  │  │ (Cube)  │  │ (Cube)  │  │(Vector) │  │(Vector) │             │   │
│  │  │  L0A    │  │  L0B    │  │   UB    │  │   UB    │             │   │
│  │  │  L0B    │  │  L0C    │  │         │  │         │             │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘             │   │
│  │         │            │            │            │                  │   │
│  │         └────────────┴────────────┴────────────┘                 │   │
│  │                      │ L2 Cache                                  │   │
│  │                      ▼                                           │   │
│  │                   Global Memory                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 各层详细说明

### 1. 用户层

**位置**: `examples/`

用户使用 Python DSL 编写内核代码，主要特点：
- 使用 `@tilelang.jit` 装饰器标记要编译的函数
- 使用 `T.prim_func` 定义内核函数
- 使用硬件原语（`T.alloc_L1`, `T.copy`, `T.gemm` 等）描述计算

### 2. Python DSL 层

**位置**: `tilelang/`

**主要子模块**:

| 子模块 | 功能 | 关键文件 |
|--------|------|----------|
| `jit/` | JIT 编译器 | `__init__.py`, `kernel.py` |
| `language/` | 语言原语 | `allocate.py`, `copy.py`, `gemm.py`, `parallel.py` |
| `engine/` | 编译引擎 | `lower.py` |
| `autotuner/` | 自动调优 | `autotune.py` |
| `cache/` | 编译缓存 | `cached.py` |

**协同关系**:
```
用户代码
  → @tilelang.jit
  → tilelang.jit.__call__
  → compile()
  → cached()
  → tilelang.engine.lower()
  → 返回 JITKernel
```

### 3. IR 变换层

**位置**: `src/transform/`

| Pass | 功能 | 输入/输出 |
|------|------|-----------|
| `frontend_legalize.cc` | 前端合法化 | TIR → 规范化 TIR |
| `layout_inference.cc` | 布局推断 | TIR → 带布局的 TIR |
| `flatten_buffer.cc` | 缓冲区扁平化 | 多维缓冲区 → 一维缓冲区 |
| `loop_vectorize.cc` | 循环向量化 | 循环 → 向量化代码 |
| `inject_pipeline.cc` | 流水线注入 | T.Pipelined → 实际流水线 |
| `ascend_lower_parallel_to_vector.cc` | Parallel → Vector | T.Parallel → 向量指令 |
| `ascend_memory_planning.cc` | 内存规划 | 自动分配缓冲区地址 |
| `ascend_sync_insert.cc` | 同步插入 | 自动插入 barrier |
| `ascend_combinecv.cc` | 核心合并 | AIC/AIV 代码合并 |
| `lower_tile_op.cc` | Tile 操作降层 | T.tile.* → 实际指令 |

### 4. 代码生成层

**位置**: `src/target/`

| 代码生成器 | 目标平台 | 输出 |
|-----------|----------|------|
| `codegen_ascend_pto.cc` | Ascend PTO | Ascend C + PTO 指令 |
| `codegen_ascend.cc` | Ascend | Ascend C |
| `codegen_cuda.cc` | NVIDIA GPU | CUDA 代码 |
| `codegen_hip.cc` | AMD GPU | HIP 代码 |
| `codegen_cpp.cc` | CPU | C++ 代码 |

**协同关系**:
```
优化后的 TIR
  → CodeGenAscendPTO::GenerateFunc()
  → 生成 Ascend C 代码
  → 使用 src/tl_templates/ascend/common.h 模板
  → 输出 .c/.h 文件
```

### 5. 第三方依赖

**位置**: `3rdparty/`

| 库 | 用途 | 协同方式 |
|----|------|----------|
| TVM | 编译器基础设施 | 提供 IR、Pass 基础设施 |
| pto-isa | PTO 指令集 | 代码生成时的指令参考 |
| CUTLASS | 矩阵乘法库 | 参考/兼容性 |

---

## 数据流示例：GEMM 内核编译

```
1. 用户代码 (examples/gemm/example_gemm.py)
   └─> @tilelang.jit
       └─> def matmul(...):
           └─> T.gemm_v0(A_L1, B_L1, C_L0)

2. JIT 编译 (tilelang/jit/__init__.py)
   └─> compile(func)
       └─> tilelang.engine.lower(func, target="ascend")

3. 降层 (tilelang/engine/lower.py)
   └─> 应用 Pass 序列:
       ├─> frontend_legalize
       ├─> layout_inference
       ├─> flatten_buffer
       ├─> ascend_lower_parallel_to_vector
       ├─> ascend_memory_planning
       └─> ascend_sync_insert

4. 代码生成 (src/target/codegen_ascend_pto.cc)
   └─> CodeGenAscendPTO::GenerateFunc()
       ├─> 遍历 TIR
       ├─> 生成 Ascend C 代码
       │   └─> pipe->GEMM(A_L1, B_L1, C_L0, ...)
       └─> 输出到文件

5. 外部编译 (华为 CANN 工具链)
   └─> Ascend C 编译器
       └─> 生成 .so 二进制

6. 运行时执行 (src/target/rt_mod_ascend_pto.cc)
   └─> 加载 .so
       ├─> 分配内存
       ├─> 传递参数
       └─> 在 NPU 上执行
```

---

## 配置和编译流程

### 安装流程

```bash
# 1. 克隆仓库
git clone --recursive https://github.com/tile-ai/tilelang-ascend.git

# 2. 设置 CANN 环境
source {cann-path}/ascend-toolkit/set_env.sh

# 3. 编译安装
bash install_ascend.sh
   ├─> 编译 C++ 部分 (CMake)
   │   ├─> 3rdparty/tvm/
   │   ├─> src/*.cc
   │   ├─> src/target/codegen_ascend_pto.cc
   │   └─> 生成 libtilelang.so
   │
   └─> 安装 Python 部分 (pip)
       ├─> tilelang/
       └─> 生成可执行程序

# 4. 设置环境变量
source set_env.sh
```

### 使用流程

```python
import tilelang as T

# 1. 定义内核
@T.jit(out_idx=[-1])
def my_gemm(M, N, K, ...):
    @T.prim_func
    def main(A: T.Tensor, B: T.Tensor, C: T.Tensor):
        # 内核实现
        ...
    return main

# 2. 实例化函数
func = my_gemm(M=1024, N=1024, K=1024)

# 3. 调用内核
output = func(input_a, input_b)
```

---

## 关键配置选项

```python
pass_configs = {
    # 自动同步插入
    "tl.ascend_auto_sync": True,

    # 自动内存规划
    "tl.ascend_memory_planning": True,

    # 自动核间同步
    "tl.ascend_auto_cv_combine": True,
    "tl.ascend_auto_cv_sync": True,

    # 其他选项
    "tir.disable_vectorize": False,
    "tl.disable_dynamic_tail_split": False,
}

@T.jit(pass_configs=pass_configs)
def my_kernel(...):
    ...
```

---

## 总结

TileLang-Ascend 是一个分层设计的编译器项目：

1. **用户层** (examples/) - 用户编写代码
2. **Python DSL 层** (tilelang/) - 提供 Python 接口
3. **IR 变换层** (src/transform/) - 编译器优化
4. **代码生成层** (src/target/) - 生成目标代码
5. **运行时层** - 执行编译后的内核

各层通过清晰的接口协同工作，最终实现从 Python DSL 到 Ascend NPU 可执行代码的完整编译流程。
