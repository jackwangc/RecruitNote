---

## 🚀 PTO 算子精度问题定位与修复总结报告(gemmi3 fast 模式)

### 一、 问题现象

* **环境**：昇腾 AI Core，同时使用 AscendC（原生）与 PTO（DSL）两种方式实现 CrossEntropy 算子。
* **症状**：原生 AscendC 算子精度正常；但 PTO 版本在执行完归一化（Subtraction）逻辑后，输出结果与预期严重不符（精度崩溃）。
* **报错（修复中途）**：编译时出现 `undeclared identifier 'n_idx'`，属于循环变量命名不一致导致的语法错误。

---

### 二、 定位思路：从“宏观”到“微观”

针对 NPU 算子的精度问题，我们采取了以下三步走策略：

1. **对标法 (Cross-Validation)**：由于 AscendC 精度正确，我们将 AscendC 的代码逻辑作为“黄金标准”，逐行对比 PTO 对应的指令执行范围。
2. **空间探测 (Memory Mapping)**：手动梳理 UB 内存地图（基于 `TASSIGN` 地址），确认每个变量的起始地址和长度。
3. **算子行为分析**：重点怀疑具有“广播”属性的矢量指令（如 `TADDS`），检查其作用的 Tensor 形状是否超出了当前逻辑行的范围。

---

### 三、 根本原因分析 (Root Cause)

#### 1. 指令作用域溢出 (The "Scope" Trap)

* **原因**：在 PTO 中，`TADDS(x_32, x_32, scalar)` 默认作用于 `x_32` 定义的**整个物理空间**（ 元素）。
* **后果**：在 `n_idx` 循环中，原本只想对“当前行”减去最大值，结果每一轮循环都对“全矩阵”进行了减法。导致第 0 行被重复扣减了 64 次，数据彻底变异。

#### 2. 内存视图映射不精确

* **原因**：PTO 不像原生 C++ 那样会自动根据指针类型处理偏移。
* **后果**：开发者必须手动计算 `16896 + (n_idx * 128) * 4`。如果漏掉 `* 4` (float 字节数) 或偏移基地址写错，数据就会读到“夹缝”里的乱码。

#### 3. 异步竞争与同步缺失

* **原因**：NPU 是异步架构。
* **后果**：在 Scalar 单元调用 `.GetValue()` 读取 Vector 单元还在计算的值时，由于缺少 `pipe_barrier(PIPE_ALL)`，读到了计算一半的中间值。

---

### 四、 修复方案对比

| 模块 | 修复前（错误/不稳） | 修复后（正确/精准） |
| --- | --- | --- |
| **操作对象** | 整个大矩阵 `x_32` | 定义“行视图” `x_32_row_view` |
| **地址绑定** | 无或偏移模糊 | `TASSIGN(view, BASE + n_idx * ROW_BYTES)` |
| **计算指令** | 全局 `TADDS` | 局部 `TADDS` (仅作用于 128 元素) |
| **同步控制** | 依赖自动同步 | 显式插入 `pipe_barrier(PIPE_ALL)` |

---

### 五、 后续如何避免类似问题？（防呆指南）

#### 1. 严格使用“视图模式”处理多维数据

在处理矩阵行/块操作时，养成先定义小形状 Tensor，再用 `TASSIGN` 绑定偏移的习惯。

> **黄金公式**：`TASSIGN(row_tensor, BASE_ADDR + row_index * row_width * sizeof(dtype))`。

#### 2. 善用指令对齐检查

每次写 `TASSIGN` 后，心算一下：**（当前起始地址 + 长度）是否  下一个变量的起始地址？** 确保内存地图没有“重叠区”。

#### 3. 打印关键节点数据

在调试阶段，不要吝啬使用 `TPRINT` 或 `DumpTensor`。

* **技巧**：将输入数据 `x` 设为规律的等差数列（0.1, 0.2, 0.3...），如果打印出来发现数据不是 0.1 开头，说明你的偏移算错了。

#### 4. 变量命名规范

在多层嵌套循环中，严禁混用 `i, j, n_idx, n_idx_1`。建议命名为 `row_idx`, `tile_idx` 等具有业务含义的名称，避免出现 `undeclared identifier` 或逻辑混淆。

---

### 💡 下一步建议

既然 PTO 精度已经调通，你可以尝试**去掉一些不必要的 `pipe_barrier(PIPE_ALL)**`，将其替换为 `PIPE_V` 甚至去掉，观察性能（TPS）是否有大幅提升，同时保持精度不变。

需要我帮你分析一下哪些位置的 Barrier 是可以优化的吗？

---
